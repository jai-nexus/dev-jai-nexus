generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Repo {
  id            Int       @id @default(autoincrement())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  nhId          String    @default("")
  name          String    @unique
  description   String?
  domainPod     String?
  engineGroup   String?
  language      String?
  status        String?
  owner         String?
  defaultBranch String?
  githubUrl     String?
  notes         Json?

  syncRuns      SyncRun[]
  domains       Domain[]
  sotEvents     SotEvent[]   // ðŸ‘ˆ new back-relation
}

model Domain {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now()) @updatedAt

  nhId       String    @default("")
  domain     String    @unique
  status     String?
  domainKey  String?
  engineType String?
  env        String?
  expiresAt  DateTime?
  notes      Json?

  repoId     Int?
  repo       Repo?      @relation(fields: [repoId], references: [id])

  sotEvents  SotEvent[] // ðŸ‘ˆ new back-relation
}

model SyncRun {
  id             Int       @id @default(autoincrement())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  type           String
  status         String
  trigger        String?

  startedAt      DateTime
  finishedAt     DateTime

  workflowRunUrl String?
  summary        String?
  payload        Json?

  repoId         Int?
  repo           Repo?     @relation(fields: [repoId], references: [id])
}

model JaiTool {
  id           Int       @id @default(autoincrement())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  name         String
  version      String?
  description  String?
  scope        String?
  status       String?

  inputSchema  Json?
  outputSchema Json?
}

model SotEvent {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now()) @updatedAt

  /// When the event actually happened (not when we ingested it)
  ts         DateTime

  /// High-level source: chatgpt | github | notion | manual | jai-format | etc.
  source     String

  /// Logical type: conversation | decision | task | design_note | sync | etc.
  kind       String

  /// Optional NH marker for this event in your hierarchy (e.g. "2.1.3.5")
  nhId       String    @default("")

  /// Short human-readable summary for dashboards
  summary    String?

  /// Full canonical blob (usually jai-format or raw export)
  payload    Json?

  /// Optional links into repo/domain registries
  repoId     Int?
  repo       Repo?     @relation(fields: [repoId], references: [id])

  domainId   Int?
  domain     Domain?   @relation(fields: [domainId], references: [id])

  @@index([ts, repoId, domainId])
}
