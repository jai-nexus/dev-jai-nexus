name: Portal Â· sync-repos

on:
  workflow_dispatch:
  schedule:
    - cron: "17 */2 * * *" # every 2 hours (offset to avoid top-of-hour pileups)

concurrency:
  group: portal-sync-repos
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      JAI_INTERNAL_API_BASE: ${{ secrets.JAI_INTERNAL_API_BASE }}
      JAI_INTERNAL_API_TOKEN: ${{ secrets.JAI_INTERNAL_API_TOKEN }}

    steps:
      - name: Ping
        run: |
          set -euo pipefail
          curl -fsS \
            -H "Authorization: Bearer $JAI_INTERNAL_API_TOKEN" \
            "$JAI_INTERNAL_API_BASE/api/internal/ping" | tee ping.json

      - name: Sync repos (index)
        run: |
          set -euo pipefail
          curl -fsS -X POST \
            -H "Authorization: Bearer $JAI_INTERNAL_API_TOKEN" \
            "$JAI_INTERNAL_API_BASE/api/internal/sync-repos" | tee response.json
          test -s response.json

      - name: Summary
        run: |
          {
            echo "## sync-repos response"
            echo
            echo '```json'
            cat response.json
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload response
        uses: actions/upload-artifact@v4
        with:
          name: portal-sync-repos
          path: |
            ping.json
            response.json
