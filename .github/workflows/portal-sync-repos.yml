name: Portal · sync-repos

on:
  workflow_dispatch:
  # uncomment once it’s stable
  # schedule:
  #   - cron: "*/30 * * * *" # every 30 minutes

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      JAI_INTERNAL_API_BASE: ${{ secrets.JAI_INTERNAL_API_BASE }}
      JAI_INTERNAL_API_TOKEN: ${{ secrets.JAI_INTERNAL_API_TOKEN }}

    steps:
      - name: Ping
        shell: bash
        run: |
          set -euo pipefail

          URL="${JAI_INTERNAL_API_BASE%/}/api/internal/ping"

          echo "Ping: $URL"
          curl -sS \
            -H "Authorization: Bearer ${JAI_INTERNAL_API_TOKEN}" \
            -H "Accept: application/json" \
            "$URL"

      - name: Sync repos (index)
        id: sync
        shell: bash
        run: |
          set -euo pipefail

          : > response.json  # always create the file so artifacts/summary never fail

          URL="${JAI_INTERNAL_API_BASE%/}/api/internal/sync-repos"
          echo "Sync: $URL"

          # Never let curl abort the step before writing the body.
          STATUS="$(curl -sS \
            -o response.json \
            -w "%{http_code}" \
            -H "Authorization: Bearer ${JAI_INTERNAL_API_TOKEN}" \
            -H "Accept: application/json" \
            -X POST \
            "$URL" || true)"

          echo "http_status=$STATUS" >> "$GITHUB_OUTPUT"

          echo "HTTP: $STATUS"
          echo "---- response.json ----"
          cat response.json || true
          echo "-----------------------"

          if [[ "$STATUS" -lt 200 || "$STATUS" -ge 300 ]]; then
            exit 1
          fi

      - name: Summary
        if: always()
        shell: bash
        run: |
          echo "## sync-repos response" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**HTTP:** ${{ steps.sync.outputs.http_status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat response.json >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload response
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-repos-response
          path: response.json
