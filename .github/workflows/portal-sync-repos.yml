name: Portal Â· sync-repos

on:
  workflow_dispatch:
  schedule:
    - cron: "17 * * * *" # hourly @ minute 17

concurrency:
  group: portal-sync-repos
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      JAI_INTERNAL_API_BASE: ${{ secrets.JAI_INTERNAL_API_BASE }}
      JAI_INTERNAL_API_TOKEN: ${{ secrets.JAI_INTERNAL_API_TOKEN }}

    steps:
      - name: Validate env
        run: |
          test -n "$JAI_INTERNAL_API_BASE" || (echo "Missing JAI_INTERNAL_API_BASE" && exit 1)
          test -n "$JAI_INTERNAL_API_TOKEN" || (echo "Missing JAI_INTERNAL_API_TOKEN" && exit 1)

      - name: Ping
        run: |
          curl -fsS \
            -H "Authorization: Bearer $JAI_INTERNAL_API_TOKEN" \
            "$JAI_INTERNAL_API_BASE/api/internal/ping"

      - name: Sync repos (index)
        run: |
          curl -fsS -X POST \
            -H "Authorization: Bearer $JAI_INTERNAL_API_TOKEN" \
            "$JAI_INTERNAL_API_BASE/api/internal/sync-repos" | tee response.json

      - name: Summary
        run: |
          echo "## sync-repos response" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat response.json >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
