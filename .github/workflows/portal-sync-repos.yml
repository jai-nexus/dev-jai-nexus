name: Portal · sync-repos

on:
  workflow_dispatch:
  # uncomment once it’s stable
  # schedule:
  #   - cron: "*/30 * * * *" # every 30 minutes

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      JAI_INTERNAL_API_BASE: ${{ secrets.JAI_INTERNAL_API_BASE }}
      JAI_INTERNAL_API_TOKEN: ${{ secrets.JAI_INTERNAL_API_TOKEN }}

    steps:
      - name: Ping
        run: |
          set -euo pipefail
          curl -sS \
            -H "Authorization: Bearer $JAI_INTERNAL_API_TOKEN" \
            "$JAI_INTERNAL_API_BASE/api/internal/ping"

      - name: Sync repos (index)
        id: sync
        run: |
          set -euo pipefail

          STATUS="$(curl -sS -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer $JAI_INTERNAL_API_TOKEN" \
            -X POST \
            "$JAI_INTERNAL_API_BASE/api/internal/sync-repos")"

          echo "http_status=$STATUS" >> "$GITHUB_OUTPUT"

          echo "HTTP $STATUS"
          echo "---- response.json ----"
          cat response.json || true
          echo "-----------------------"

          if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## sync-repos response" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**HTTP:** ${{ steps.sync.outputs.http_status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat response.json >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload response
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-repos-response
          path: response.json
