name: role_guardrails

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  role_guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enforce Role / Path / Evidence
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            function fail(msg) {
              core.setFailed(msg);
              throw new Error(msg);
            }

            const pr = context.payload.pull_request;
            if (!pr) fail("Not a pull_request event.");

            const body = pr.body || "";
            const roleLine = body.split("\n").find(l => l.trim().toLowerCase().startsWith("role:"));
            if (!roleLine) fail("Missing 'Role:' line in PR body (see PR template).");

            const role = roleLine.split(":").slice(1).join(":").trim();
            if (!role) fail("Role line is empty. Use: Role: JAI::DEV::<ROLE>");

            const rolemapPath = "roles/rolemap.json";
            if (!fs.existsSync(rolemapPath)) fail(`Missing ${rolemapPath}. Add rolemap.json to define guardrails.`);
            const rolemap = JSON.parse(fs.readFileSync(rolemapPath, "utf8"));

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            const changed = files.map(f => f.filename);

            // Blocked paths (privacy/cleanliness)
            for (const p of changed) {
              if (rolemap.blockedExact?.includes(p)) {
                fail(`Blocked file changed: ${p}`);
              }
              for (const pref of (rolemap.blockedPrefixes || [])) {
                if (p.startsWith(pref)) fail(`Blocked path changed: ${p}`);
              }
              // Extra safety: never allow env files anywhere
              if (p.includes(".env")) fail(`Blocked: env-related file changed: ${p}`);
            }

            // Determine per-file requirements
            const violations = [];
            let evidenceRequired = false;

            function matchRule(path) {
              for (const r of (rolemap.rules || [])) {
                for (const pref of (r.pathsPrefix || [])) {
                  if (path.startsWith(pref)) return r;
                }
              }
              return null;
            }

            for (const p of changed) {
              const rule = matchRule(p);
              const allowed = rule ? rule.allowedRoles : (rolemap.defaultAllowedRoles || []);
              const needsEvidence = rule ? !!rule.evidenceRequired : false;

              if (needsEvidence) evidenceRequired = true;

              if (!allowed.includes(role)) {
                violations.push({ file: p, rule: rule ? rule.id : "default", allowed });
              }
            }

            if (violations.length) {
              const lines = violations.slice(0, 25).map(v =>
                `- ${v.file} (rule: ${v.rule}) allowed: ${v.allowed.join(", ")}`
              ).join("\n");
              fail(`Role '${role}' is not allowed for some changed files:\n${lines}`);
            }

            // Evidence section check (only when required)
            if (evidenceRequired) {
              const title = (rolemap.evidenceSectionTitle || "Evidence").toLowerCase();
              const idx = body.toLowerCase().indexOf(title + ":");
              if (idx === -1) fail("Evidence required, but no 'Evidence:' section found in PR body.");

              const after = body.slice(idx + (title.length + 1)).trim();
              // Require at least one non-empty line that isn't just a header
              const meaningful = after.split("\n").map(s => s.trim()).filter(s =>
                s.length > 0 && !s.toLowerCase().startsWith("risk:") && !s.toLowerCase().startsWith("notes") && !s.toLowerCase().startsWith("handoff")
              );
              if (meaningful.length === 0) fail("Evidence required, but Evidence section appears empty.");
            }

            core.info(`Role guardrails passed for role=${role}. EvidenceRequired=${evidenceRequired}. Files=${changed.length}`);
