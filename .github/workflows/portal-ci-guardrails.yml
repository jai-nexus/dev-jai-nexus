name: portal_ci_guardrails

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "portal/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/portal-ci-guardrails.yml"
  push:
    paths:
      - "portal/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/portal-ci-guardrails.yml"

permissions:
  contents: read

concurrency:
  group: dev-jai-nexus-portal-guardrails-${{ github.ref }}
  cancel-in-progress: true

jobs:
  guardrails:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # Prisma generate runs in postinstall; CI doesn't have secrets, so provide harmless dummy URLs.
      DATABASE_URL: postgresql://prisma:prisma@localhost:5432/prisma?schema=public
      DIRECT_URL: postgresql://prisma:prisma@localhost:5432/prisma?schema=public
      NEXT_TELEMETRY_DISABLED: "1"
      CI: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable pnpm (Corepack)
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare pnpm@10.26.0 --activate
          pnpm -v

      - name: Install deps (workspace)
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile

      - name: Resolve portal directory
        id: portal_dir
        shell: bash
        run: |
          set -euo pipefail

          if [ -f "portal/package.json" ]; then
            DIR="portal"
          elif [ -f "portal/portal/package.json" ]; then
            DIR="portal/portal"
          else
            echo "::error::Could not find portal/package.json or portal/portal/package.json"
            echo "Repo root listing:"
            ls -la
            echo "portal listing:"
            ls -la portal || true
            exit 1
          fi

          echo "PORTAL_DIR=$DIR" >> "$GITHUB_ENV"
          echo "dir=$DIR" >> "$GITHUB_OUTPUT"
          echo "Using PORTAL_DIR=$DIR"

      - name: Guardrail - forbid generated Prisma imports
        shell: pwsh
        run: |
          pwsh -NoProfile -File "./${{ env.PORTAL_DIR }}/scripts/check-forbidden-prisma-imports.ps1" `
            -Root "./${{ env.PORTAL_DIR }}/src"

      - name: Guardrail - Prisma validate
        working-directory: ${{ env.PORTAL_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          pnpm exec prisma validate

      - name: Guardrail - Type check
        working-directory: ${{ env.PORTAL_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          pnpm exec tsc --noEmit

      - name: Build portal
        working-directory: ${{ env.PORTAL_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          pnpm build
